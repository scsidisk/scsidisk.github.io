<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="author" content="scsidisk" />
    <title>有效防御PHP木马攻击的技巧 | scsidisk</title>
    <link href="/feed/" rel="alternate" title="scsidisk" type="application/atom+xml" />
    <link rel="stylesheet" href="/media/css/highlight.css">
    <link href='/media/webfonts/ss-social.css' rel='stylesheet'>
    <link href='/media/webfonts/ss-standard.css' rel='stylesheet'>
    <link href="/media/css/screen.css" rel="stylesheet">

    <script type="text/javascript" src="/media/js/jquery-1.7.1.min.js"></script>
  </head>
  <body>
    <div id="container">
      <div id="main" role="main">
        <header>
        <div class="buttons">
          <a href="/" class="ss-icon" title="Go to homepage">home</a>
          <a href="/categories" class="ss-icon" title="Category" >list</a>
          <a href="/tags" class="ss-icon" title="Tag Cloud" >tags</a>
          <a href="/guestbook" class="ss-icon" title="Guest Book" >talk</a>
          <a href="/about" class="ss-icon" title="About" >user</a>
          <a href="/feed" class="ss-icon" title="Subscribe by RSS" >rss</a>
        </div>
        <h1>有效防御PHP木马攻击的技巧</h1>
        </header>
        <hr>
        <article class="content">
        <section class="post">
<p>1、防止跳出web目录</p>

<p>首先修改httpd.conf，如果你只允许你的php脚本程序在web目录里操作，还可以修改httpd.conf文件限制php的
操作路径。比如你的web目录是/usr/local/apache/htdocs，那么在httpd.conf里加上这么几行：</p>

<p>php_admin_value open_basedir /usr/local/apache</p>

<p>/htdocs</p>

<p>这样，如果脚本要读取/usr/local/apache/htdocs以外的文件将不会被允许，如果错误显示打开的话会提示这样的错
误：</p>

<p>Warning: open_basedir restriction in effect. File is in wrong directory
in</p>

<p>/usr/local/apache/htdocs/open.php on line 4</p>

<p>等等。</p>

<p>2、防止php木马执行webshell</p>

<p>打开safe_mode，</p>

<p>在，php.ini中设置</p>

<p>disable_functions= passthru，exec，shell_exec，system</p>

<p>二者选一即可，也可都选</p>

<p>3、防止php木马读写文件目录</p>

<p>在php.ini中的</p>

<p>disable_functions= passthru，exec，shell_exec，system</p>

<p>后面加上php处理文件的函数</p>

<p>主要有</p>

<p>fopen，mkdir，rmdir，chmod，unlink，dir</p>

<p>fopen，fread，fclose，fwrite，file_exists</p>

<p>closedir，is_dir，readdir.opendir</p>

<p>fileperms.copy，unlink，delfile</p>

<p>即成为</p>

<p>disable_functions=
passthru，exec，shell_exec，system，fopen，mkdir，rmdir，chmod，unlink，dir</p>

<p>，fopen，fread，fclose，fwrite，file_exists</p>

<p>，closedir，is_dir，readdir.opendir</p>

<p>，fileperms.copy，unlink，delfile</p>

<p>ok，大功告成，php木马拿我们没辙了，遗憾的是这样的话，利用文本数据库的那些东西就都不能用了。</p>

<p>如果是在windos平台下搭建的apache我们还需要注意一点，apache默认运行是system权限，这很恐怖，这让人感觉很
不爽.那我们就给apache降降权限吧。</p>

<p>net user apache fuckmicrosoft /add</p>

<p>net localgroup users apache /del</p>

<p>ok.我们建立了一个不属于任何组的用户apche。</p>

<p>我们打开计算机管理器，选服务，点apache服务的属性，我们选择log
on，选择this
account，我们填入上面所建立的账户和密码，重启apache服务，ok，apache运行在低权限下了。</p>

<p>实际上我们还可以通过设置各个文件夹的权限，来让apache用户只能执行我们想让它能干的事情，给每一个目录建立一个单独能读写的用
户。这也是当前很多虚拟主机提供商的流行配置方法哦，不过这种方法用于防止这里就显的有点大材小用了。</p>

<p>php_admin_value 和 php_value的区别</p>

<p>php_admin_value(php_admin_flag)命令只能用在Apache的httpd.conf文件中，而
php_value(php_flag)则是用在.htaccess文件中的。</p>

<p>若加上 php_admin_value导致上传文件错误,可以这样写</p>

<p>php_admin_value open_basedir "/usr/local/apache/htdocs/www:/tmp" l</p>

<p>注意：两个目录之间是冒号隔开（Linux中）。</p>

<p>如果是Windows中，将冒号换成分号：</p>

<p>php_admin_value open_basedir "d:/www/mysite;c:/windows/temp"</p>

<p>/temp 是你系统默认的缓存目录 一般都是这样的 不清楚可以看一下phpinfo</p>

<div class="posttagsblock">
[ ](http://technorati.com/tag/CentOS)

</div>




</section>
<section class="meta">
<span class="author">
  <a href="http://scsidisk.github.io">scsidisk</a>
</span>
<span class="time">
  /
  <time datetime="2010-12-28">2010-12-28</time>
</span>
<br />
<span class="license">
  Published under <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">(CC) BY-NC-SA</a>
</span>

<span class="categories">
  in categories
  
  <a href="/categories/#php" title="php">php</a>&nbsp;
  
</span>


<span class="tags">
  tagged with
  
  <a href="/tags/#Nginx," title="Nginx,">Nginx,</a>&nbsp;
  
  <a href="/tags/#PHP," title="PHP,">PHP,</a>&nbsp;
  
  <a href="/tags/#木马" title="木马">木马</a>&nbsp;
  
</span>

</section>
<section class="comment">
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'scsidiskgithuio'; // required: replace example with your forum shortname
    var disqus_url = 'http://scsidisk.github.io/2010/12/effective_defense_php_trojan_horse_attack_skills/';
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</section>


<script type="text/javascript">
$(function(){
  $(document).keydown(function(e) {
    var url = false;
        if (e.which == 37 || e.which == 74) {  // Left arrow and J
            
        url = 'http://scsidisk.github.io/2010/12/version_information_hiding_apache_and_php/';
        
        }
        else if (e.which == 39 || e.which == 75) {  // Right arrow and K
            
        url = 'http://scsidisk.github.io/2010/12/how_to_set_hostname_on_linux/';
        
        }
        if (url) {
            window.location = url;
        }
  });
})
</script>


        </article>
      </div>

    <footer>
        <p><small>Powered by <a href="https://github.com/mojombo/jekyll">Jekyll</a> | Copyright 2008 - 2014 by <a href="http://scsidisk.github.io">scsidisk</a> | <span class="label label-info">2014-06-10 02:54:24 CST</span></small></p>
    </footer>

    </div>

    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', '');
      _gaq.push(['_trackPageview']);
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </body>
</html>
